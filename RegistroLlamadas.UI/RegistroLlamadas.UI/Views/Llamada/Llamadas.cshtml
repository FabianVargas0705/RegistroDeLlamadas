@model IEnumerable<LlamadaModel>

@{
    ViewData["Title"] = "Gestión de Llamadas";
}

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 class="mb-0">Llamadas Registradas</h3>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalNuevaLlamada">
            <i class="bi bi-plus-circle"></i> Nueva Llamada
        </button>
    </div>

    <div class="table-responsive">
        <table id="tablaLlamadas" class="table table-striped table-bordered w-100">
            <thead>
                <tr>
                    <th>Responsable</th>
                    <th>Lugar</th>
                    <th>Cliente</th>
                    <th>Equipo</th>
                    <th>Fecha</th>
                    <th>Hora Inicio</th>
                    <th>Hora Final</th>
                    <th>Promat</th>
                    <th>Asunto</th>
                    <th>Estado</th>
                    <th>Tipo Atención</th>
                    <th>Acciones</th>
                </tr>
            </thead>

            <tbody>
                @foreach (var item in Model)
                {
                    <tr>
                        <td>@(item.Usuario?.Nombre ?? "-")</td>
                        <td>@(item.Centro?.Nombre ?? "-")</td>
                        <td>@(item.Cliente?.Nombre ?? "-")</td>
                        <td>@(item.Equipo?.Nombre ?? "-")</td>
                        <td>@item.Fecha.ToString("yyyy-MM-dd")</td>
                        <td>@item.HoraInicio.ToString(@"hh\:mm")</td>
                        <td>@(item.HoraFinal?.ToString(@"hh\:mm") ?? "-")</td>
                        <td>@(item.Promat ?? "-")</td>
                        <td>@(item.Asunto ?? "-")</td>
                        <td>@(item.Estado?.Descripcion ?? "-")</td>
                        <td>@(item.TipoAtencion?.Nombre ?? "-")</td>
                        <td>
                            <button class="btn btn-sm btn-outline-secondary" data-id="@item.IdLlamada">
                                <i class="bi bi-pencil-square"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" data-id="@item.IdLlamada">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

<div class="modal fade" id="modalNuevaLlamada" tabindex="-1" aria-labelledby="modalNuevaLlamadaLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="modalNuevaLlamadaLabel">
                    <i class="bi bi-telephone-plus"></i> Registrar Nueva Llamada
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>

            <form id="formNuevaLlamada">
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label for="fecha" class="form-label">Fecha</label>
                            <input type="date" class="form-control" id="fecha" required />
                        </div>
                        <div class="col-md-4">
                            <label for="horaInicio" class="form-label">Hora Inicio</label>
                            <input type="time" class="form-control" id="horaInicio" required />
                        </div>
                        <div class="col-md-4">
                            <label for="horaFinal" class="form-label">Hora Final</label>
                            <input type="time" class="form-control" id="horaFinal" />
                        </div>

                        <div class="col-md-6">
                            <label for="promat" class="form-label">Promat</label>
                            <input type="text" class="form-control" id="promat" maxlength="20" />
                        </div>

                        <div class="col-md-6">
                            <label for="asunto" class="form-label">Asunto</label>
                            <input type="text" class="form-control" id="asunto" maxlength="200" />
                        </div>

                        <div class="col-md-4">
                            <label for="correoEnviado" class="form-label">Correo Enviado</label>
                            <select id="correoEnviado" class="form-select">
                                <option value="true">Sí</option>
                                <option value="false" selected>No</option>
                            </select>
                        </div>

                        <div class="col-md-4">
                            <label for="equipoId" class="form-label">Equipo</label>
                            <input type="number" class="form-control" id="equipoId" placeholder="ID Equipo" />
                        </div>

                        <div class="col-md-4">
                            <label for="usuarioId" class="form-label">Usuario</label>
                            <input type="number" class="form-control" id="usuarioId" placeholder="ID Usuario" />
                        </div>

                        <div class="col-md-4">
                            <label for="clienteId" class="form-label">Cliente</label>
                            <input type="number" class="form-control" id="clienteId" placeholder="ID Cliente" />
                        </div>

                        <div class="col-md-4">
                            <label for="centroId" class="form-label">Centro</label>
                            <input type="number" class="form-control" id="centroId" placeholder="ID Centro" />
                        </div>

                        <div class="col-md-4">
                            <label for="estadoId" class="form-label">Estado</label>
                            <input type="number" class="form-control" id="estadoId" placeholder="ID Estado" />
                        </div>

                        <div class="col-md-4">
                            <label for="tipoAtencionId" class="form-label">Tipo de Atención</label>
                            <input type="number" class="form-control" id="tipoAtencionId" placeholder="ID Tipo" />
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            // Inicializa DataTable
            $('#tablaLlamadas').DataTable({
                language: { url: 'https://cdn.datatables.net/plug-ins/1.13.4/i18n/es-ES.json' },
                pageLength: 5,
                responsive: true
            });

            // Restablece el formulario al cerrar el modal (para empezar de nuevo)
            $('#modalNuevaLlamada').on('hidden.bs.modal', function () {
                $('#formNuevaLlamada')[0].reset();
            });

            // Manejo del formulario del modal
            $('#formNuevaLlamada').on('submit', function (e) {
                e.preventDefault();

                const nueva = {
                    fecha: $('#fecha').val(),
                    horaInicio: $('#horaInicio').val(),
                    horaFinal: $('#horaFinal').val(),
                    promat: $('#promat').val(),
                    asunto: $('#asunto').val(),
                    correoEnviado: $('#correoEnviado').val() === "true",
                    equipoId: $('#equipoId').val() || null,
                    usuarioId: $('#usuarioId').val() || null,
                    clienteId: $('#clienteId').val() || null,
                    centroId: $('#centroId').val() || null,
                    estadoId: $('#estadoId').val() || null,
                    tipoAtencionId: $('#tipoAtencionId').val() || null
                };

                console.log("Datos a enviar (simulación):", nueva);

                // Cierra el modal después de procesar el envío (simulado)
                const modalElement = document.getElementById('modalNuevaLlamada');
                // Obtiene la instancia del modal de Bootstrap y la oculta
                const modalBootstrap = bootstrap.Modal.getInstance(modalElement) || new bootstrap.Modal(modalElement);
                modalBootstrap.hide();

                // Aquí iría el código AJAX real para guardar los datos.

            });
        });
    </script>
}