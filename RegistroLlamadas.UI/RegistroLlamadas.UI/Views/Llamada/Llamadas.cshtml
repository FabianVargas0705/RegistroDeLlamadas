@model LlamadasViewModel

@{
    ViewData["Title"] = "Gestión de Llamadas";
}

<!-- CSS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
<link href="~/css/llamadasview.css" rel="stylesheet" />


<div class="container-fluid mt-4">
    <!-- Header con información -->
    <div class="page-header">
        <div class="d-flex justify-content-between align-items-start flex-wrap gap-3">
            <div>
                <h2 class="mb-2">
                    <i class="bi bi-telephone-fill text-primary"></i>
                    Gestión de Llamadas
                </h2>
                <p class="text-muted mb-0">
                    <i class="bi bi-calendar3"></i> 
                    <span id="fechaActual"></span>
                </p>
            </div>
            <div class="quick-actions">
                <button class="btn btn-outline-secondary" onclick="window.location.href='/Llamada/Dashboard'">
                    <i class="bi bi-bar-chart-line"></i> Dashboard
                </button>
                <button class="btn btn-outline-secondary" id="btnExportar">
                    <i class="bi bi-download"></i> Exportar
                </button>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalNuevaLlamada">
                    <i class="bi bi-plus-circle"></i> Nueva Llamada
                </button>
            </div>
        </div>
    </div>

    <!-- Tarjetas de estadísticas -->
    <div class="stats-cards" id="statsCards">
        <div class="stat-card">
            <div class="icon bg-primary bg-opacity-10 text-primary">
                <i class="bi bi-telephone"></i>
            </div>
            <div class="value" id="totalLlamadas">0</div>
            <div class="label">Total Llamadas</div>
        </div>
        <div class="stat-card">
            <div class="icon bg-success bg-opacity-10 text-success">
                <i class="bi bi-check-circle"></i>
            </div>
            <div class="value text-success" id="totalFinalizadas">0</div>
            <div class="label">Finalizadas</div>
        </div>
        <div class="stat-card">
            <div class="icon bg-warning bg-opacity-10 text-warning">
                <i class="bi bi-clock-history"></i>
            </div>
            <div class="value text-warning" id="totalPendientes">0</div>
            <div class="label">Pendientes</div>
        </div>
        <div class="stat-card">
            <div class="icon bg-info bg-opacity-10 text-info">
                <i class="bi bi-hourglass-split"></i>
            </div>
            <div class="value text-info" id="tiempoPromedio">0h</div>
            <div class="label">Tiempo Promedio</div>
        </div>
    </div>

    <!-- Filtros -->
    <div class="filters-section">
        <div class="row g-3 align-items-end">
            <div class="col-md-3">
                <label class="form-label small text-muted">Buscar</label>
                <input type="text" id="searchGlobal" class="form-control" placeholder="Buscar en todas las columnas...">
            </div>
            <div class="col-md-2">
                <label class="form-label small text-muted">Estado</label>
                <select id="filtroEstado" class="form-select">
                    <option value="">Todos</option>
                    <option value="Finalizado">Finalizado</option>
                    <option value="Pendiente">Pendiente</option>
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label small text-muted">Fecha Desde</label>
                <input type="date" id="filtroFechaDesde" class="form-control">
            </div>
            <div class="col-md-2">
                <label class="form-label small text-muted">Fecha Hasta</label>
                <input type="date" id="filtroFechaHasta" class="form-control">
            </div>
            <div class="col-md-3">
                <button class="btn btn-secondary w-100" id="btnLimpiarFiltros">
                    <i class="bi bi-x-circle"></i> Limpiar Filtros
                </button>
            </div>
        </div>
    </div>

    <!-- Tabla -->
    <div class="table-card">
        <div class="table-responsive">
            <table id="tablaLlamadas" class="table table-hover align-middle w-100">
                <thead>
                    <tr>
                        <th>
                            <input type="checkbox" id="selectAll" class="form-check-input">
                        </th>
                        <th>Responsable</th>
                        <th>Lugar</th>
                        <th>Cliente</th>
                        <th>Equipo</th>
                        <th>Fecha</th>
                        <th>Hora Inicio</th>
                        <th>Hora Final</th>
                        <th>Promat</th>
                        <th>Asunto</th>
                        <th>Estado</th>
                        <th class="text-center">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Model.Llamadas)
                    {
                        <tr data-id="@item.IdLlamada">
                            <td>
                                <input type="checkbox" class="form-check-input row-checkbox">
                            </td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="avatar bg-primary bg-opacity-10 text-primary rounded-circle me-2" style="width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 600;">
                                        @((item.Usuario?.Nombre ?? "?").Substring(0, 1).ToUpper())
                                    </div>
                                    <span>@(item.Usuario?.Nombre ?? "-")</span>
                                </div>
                            </td>
                            <td>@(item.Centro?.Nombre ?? "-")</td>
                            <td>@(item.Cliente?.Nombre ?? "-")</td>
                            <td>
                                @if (!string.IsNullOrEmpty(item.Equipo?.Nombre))
                                {
                                    <span class="badge bg-secondary bg-opacity-10 text-secondary">
                                        <i class="bi bi-laptop"></i> @item.Equipo.Nombre
                                    </span>
                                }
                                else
                                {
                                    <span class="text-muted">-</span>
                                }
                            </td>
                            <td>
                                <small>@item.Fecha.ToString("dd/MM/yyyy")</small>
                            </td>
                            <td>
                                <span class="badge bg-info bg-opacity-10 text-info">
                                    <i class="bi bi-clock"></i> @item.HoraInicio.ToString(@"hh\:mm")
                                </span>
                            </td>
                            <td>
                                @if (item.HoraFinal.HasValue)
                                {
                                    <span class="badge bg-success bg-opacity-10 text-success">
                                        <i class="bi bi-check-circle"></i> @item.HoraFinal.Value.ToString(@"hh\:mm")
                                    </span>
                                }
                                else
                                {
                                    <span class="text-muted">-</span>
                                }
                            </td>
                            <td>
                                @if (!string.IsNullOrEmpty(item.Promat))
                                {
                                    <code class="small">@item.Promat</code>
                                }
                                else
                                {
                                    <span class="text-muted">-</span>
                                }
                            </td>
                            <td>
                                <div class="text-truncate" style="max-width: 200px;" title="@(item.Asunto ?? "-")">
                                    @(item.Asunto ?? "-")
                                </div>
                            </td>
                            <td>
                                <span class="status-badge status-@(item.EstadoId == 3 ? "finalizado" : "activo")">
                                    @(item.Estado?.Descripcion ?? "-")
                                </span>
                            </td>
                            <td>
                                <div class="d-flex gap-1 justify-content-center">
                                    @if (item.UsuarioId == ViewBag.UsuarioIdActual && item.EstadoId != 3)
                                    {
                                        <button type="button"
                                                class="btn btn-success btn-sm btn-action btn-finalizar"
                                                data-id="@item.IdLlamada"
                                                data-bs-toggle="tooltip"
                                                title="Finalizar">
                                            <i class="bi bi-check-circle"></i>
                                        </button>
                                    }
                                    <button class="btn btn-info btn-sm btn-action btn-ver" 
                                            data-id="@item.IdLlamada"
                                            data-bs-toggle="tooltip"
                                            title="Ver detalles">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                    <button class="btn btn-warning btn-sm btn-action btn-editar" 
                                            data-id="@item.IdLlamada"
                                            data-bs-toggle="tooltip"
                                            title="Editar">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button class="btn btn-danger btn-sm btn-action btn-eliminar" 
                                            data-id="@item.IdLlamada"
                                            data-bs-toggle="tooltip"
                                            title="Eliminar">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Overlay de carga -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
        <span class="visually-hidden">Cargando...</span>
    </div>
</div>

<!-- Modal Nueva/Editar Llamada -->
<div class="modal fade" id="modalNuevaLlamada" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="modalNuevaLlamadaLabel">
                    <i class="bi bi-telephone-plus"></i> Registrar Nueva Llamada
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>

            <form id="formNuevaLlamada">
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label for="fecha" class="form-label">Fecha <span class="text-danger">*</span></label>
                            <input type="date" class="form-control" id="fecha" required />
                        </div>
                        <div class="col-md-4">
                            <label for="horaInicio" class="form-label">Hora Inicio <span class="text-danger">*</span></label>
                            <input type="time" class="form-control" id="horaInicio" required />
                        </div>
                        <div class="col-md-4">
                            <label for="horaFinal" class="form-label">Hora Final</label>
                            <input type="time" class="form-control" id="horaFinal" />
                        </div>

                        <div class="col-md-6">
                            <label for="usuarioId" class="form-label">Responsable <span class="text-danger">*</span></label>
                            <select id="usuarioId" class="form-select select2" required>
                                <option value="">Seleccione un responsable</option>
                                @if (Model.Usuarios != null)
                                {
                                    @foreach (var usuario in Model.Usuarios)
                                    {
                                        <option value="@usuario.ID">@usuario.Nombre</option>
                                    }
                                }
                            </select>
                        </div>

                        <div class="col-md-6">
                            <label for="centroId" class="form-label">Centro/Lugar <span class="text-danger">*</span></label>
                            <select id="centroId" class="form-select select2" required>
                                <option value="">Seleccione un centro</option>
                                @if (Model.Centros != null)
                                {
                                    @foreach (var centro in Model.Centros)
                                    {
                                        <option value="@centro.ID">@centro.Nombre</option>
                                    }
                                }
                            </select>
                        </div>

                        <div class="col-md-6">
                            <label for="clienteId" class="form-label">Cliente <span class="text-danger">*</span></label>
                            <select id="clienteId" class="form-select select2" required>
                                <option value="">Seleccione un cliente</option>
                                @if (Model.Clientes != null)
                                {
                                    @foreach (var cliente in Model.Clientes)
                                    {
                                        <option value="@cliente.ID">
                                            @cliente.Identificacion - @cliente.Nombre
                                        </option>
                                    }
                                }
                            </select>
                        </div>

                        <div class="col-md-6">
                            <label for="equipoId" class="form-label">Equipo</label>
                            <select id="equipoId" class="form-select select2">
                                <option value="">Seleccione un equipo</option>
                                @if (Model.Equipos != null)
                                {
                                    @foreach (var equipo in Model.Equipos)
                                    {
                                        <option value="@equipo.ID">@equipo.Nombre</option>
                                    }
                                }
                            </select>
                        </div>

                        <div class="col-md-12">
                            <label for="promat" class="form-label">Promat</label>
                            <input type="text" class="form-control" id="promat" maxlength="20" placeholder="Código Promat" />
                        </div>

                        <div class="col-12">
                            <label for="asunto" class="form-label">Asunto</label>
                            <textarea class="form-control" id="asunto" rows="3" maxlength="200" placeholder="Describa el asunto de la llamada"></textarea>
                            <div class="form-text">
                                <span id="contadorAsunto">0</span> / 200 caracteres
                            </div>
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle"></i> Cancelar
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-save"></i> Guardar
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Ver Detalles -->
<div class="modal fade" id="modalVerLlamada" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title">
                    <i class="bi bi-info-circle-fill"></i> Detalles de la Llamada
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="detallesLlamada">
                <!-- Contenido dinámico -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Finalizar Llamada -->
<div class="modal fade" id="modalFinalizarLlamada" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="bi bi-check-circle-fill"></i> Finalizar Llamada
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>

            <form id="formFinalizarLlamada">
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle-fill me-2"></i>
                        Describa detalladamente las acciones realizadas y la solución aplicada.
                    </div>

                    <div class="row g-3">
                        <div class="col-12">
                            <label for="descripcionSolucion" class="form-label">
                                Descripción de la Solución <span class="text-danger">*</span>
                            </label>
                            <textarea class="form-control" id="descripcionSolucion" rows="6" maxlength="1000" required></textarea>
                            <div class="form-text">
                                <span id="contadorCaracteres">0</span> / 1000 caracteres
                            </div>
                        </div>

                        <div class="col-md-6">
                            <label for="horaFinalizacion" class="form-label">
                                Hora de Finalización <span class="text-danger">*</span>
                            </label>
                            <input type="time" class="form-control" id="horaFinalizacion" required />
                        </div>

                        <div class="col-md-6">
                            <label for="correoEnviadoFinal" class="form-label">¿Enviar correo al cliente?</label>
                            <select id="correoEnviadoFinal" class="form-select">
                                <option value="false">No</option>
                                <option value="true">Sí</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle"></i> Cancelar
                    </button>
                    <button type="submit" class="btn btn-success">
                        <i class="bi bi-check-circle"></i> Finalizar Llamada
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
      
@section Scripts {
    <script src="~/js/llamadasview.js"></script>
    

}