@model VisitasViewModel
@{
    ViewData["Title"] = "Gestión de Visitas";
}

<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link href="~/css/llamadasview.css" rel="stylesheet" />

<div class="container-fluid mt-4">

    <div class="page-header">
        <div class="d-flex justify-content-between align-items-start flex-wrap gap-3">
            <div>
                <h2 class="mb-2">
                    <i class="bi bi-geo-alt-fill text-danger"></i>
                    Gestión de Visitas - @ViewBag.Titulo
                </h2>
                <p class="text-muted mb-0">
                    <i class="bi bi-calendar3"></i>
                    <span id="fechaActual"></span>
                </p>
            </div>

            <div class="quick-actions">
                <a class="btn btn-outline-secondary" asp-action="DashboardView" asp-controller="Dashboard">
                    <i class="bi bi-bar-chart-line"></i> Dashboard
                </a>
            </div>
        </div>
    </div>

    <!-- Estadísticas -->
    <div class="stats-cards" id="statsCards">
        <div class="stat-card">
            <div class="icon bg-primary bg-opacity-10 text-primary"><i class="bi bi-list-check"></i></div>
            <div class="value" id="totalVisitas">0</div>
            <div class="label">Total Visitas</div>
        </div>
        <div class="stat-card">
            <div class="icon bg-success bg-opacity-10 text-success"><i class="bi bi-check2-circle"></i></div>
            <div class="value text-success" id="totalFinalizadas">0</div>
            <div class="label">Finalizadas</div>
        </div>
        <div class="stat-card">
            <div class="icon bg-warning bg-opacity-10 text-warning"><i class="bi bi-clock-history"></i></div>
            <div class="value text-warning" id="totalPendientes">0</div>
            <div class="label">Pendientes</div>
        </div>
    </div>

    <!-- Filtros -->
    <div class="filters-section">
        <div class="row g-3 align-items-end">

            <div class="col-md-3">
                <label class="form-label small text-muted">Buscar</label>
                <input type="text" id="searchGlobal" class="form-control" placeholder="Buscar...">
            </div>

            <div class="col-md-2">
                <label class="form-label small text-muted">Estado</label>
                <select id="filtroEstado" class="form-select">
                    <option value="">Todos</option>
                    <option value="Pendiente">Pendiente</option>
                    <option value="Finalizada">Finalizada</option>
                </select>
            </div>

            <div class="col-md-2">
                <label class="form-label small text-muted">Fecha</label>
                <input type="date" id="filtroFecha" class="form-control" />
            </div>

            <div class="col-md-3">
                <button class="btn btn-secondary w-100" id="btnLimpiarFiltros">
                    <i class="bi bi-x-circle"></i> Limpiar Filtros
                </button>
            </div>
        </div>
    </div>

    <!-- Tabla -->
    <div class="table-card">
        <div class="table-responsive">
            <table id="tablaVisitas" class="table table-hover align-middle w-100">
                <thead>
                    <tr>
                        <th>Responsable</th>
                        <th>Cliente</th>
                        <th>Centro</th>
                        <th>Fecha</th>
                        <th>Inicio</th>
                        <th>Final</th>
                        <th>Estado</th>
                        <th class="text-center">Acciones</th>
                    </tr>
                </thead>

                <tbody>
                    @foreach (var v in Model.Visitas)
                    {
                        <tr data-id="@v.IdVisita">

                            <td>@v.UsuarioNombre</td>
                            <td>@v.ClienteNombre</td>
                            <td>@v.CentroNombre</td>

                            <td>@v.FechaVisita.ToString("dd/MM/yyyy")</td>
                            <td>@v.HoraInicio.ToString(@"hh\:mm")</td>

                            <td>
                                @if (v.HoraFinal.HasValue)
                                {
                                    <span class="badge bg-success bg-opacity-10 text-success">
                                        <i class="bi bi-check-circle"></i> @v.HoraFinal.Value.ToString(@"hh\:mm")
                                    </span>
                                }
                                else
                                {
                                    <span class="text-muted">-</span>
                                }
                            </td>

                            <td>
                                <span class="status-badge status-@(v.EstadoId == 3 ? "finalizado" : "activo")">
                                    @v.EstadoNombre
                                </span>
                            </td>

                            <td class="text-center">
                                <div class="d-flex gap-1 justify-content-center">

                                    @if ((v.UsuarioId == ViewBag.UsuarioIdActual && v.EstadoId != 10) || (ViewBag.RolActual == 1003 && v.EstadoId != 10))
                                    {
                                        <button class="btn btn-success btn-sm btn-finalizar-visita"
                                                data-id="@v.IdVisita"
                                                title="Finalizar Visita">
                                            <i class="bi bi-check2-circle"></i>
                                        </button>
                                    }

                                    <button class="btn btn-info btn-sm btn-ver"
                                            data-id="@v.IdVisita"
                                            title="Ver detalles">
                                        <i class="bi bi-eye"></i>
                                    </button>

                                </div>
                            </td>
                        </tr>
                    }
                </tbody>

            </table>
        </div>
    </div>

</div>

<!-- Modal Finalizar Visita -->
<div class="modal fade" id="modalFinalizarVisita" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">

            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="bi bi-check2-circle"></i> Finalizar Visita
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>

            <form id="formFinalizarVisita">
                <div class="modal-body">

                    <input type="hidden" id="finalizarVisitaId" />

                    <div class="alert alert-info">
                        <i class="bi bi-info-circle-fill me-2"></i>
                        Describa brevemente las acciones realizadas durante la visita.
                    </div>

                    <div class="row g-3">

                        <div class="col-12">
                            <label class="form-label fw-bold">Descripción <span class="text-danger">*</span></label>
                            <textarea id="descripcionVisita" class="form-control" rows="5" maxlength="500" required></textarea>
                            <div class="form-text">
                                <span id="contadorVisita">0</span> / 500 caracteres
                            </div>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label fw-bold">Hora Final <span class="text-danger">*</span></label>
                            <input type="time" class="form-control" id="horaFinalVisita" required />
                        </div>

                        <div class="col-md-6">
                            <label class="form-label fw-bold">¿Enviar correo al cliente?</label>
                            <select id="correoEnviadoVisita" class="form-select">
                                <option value="false">No</option>
                                <option value="true">Sí</option>
                            </select>
                        </div>

                    </div>

                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle"></i> Cancelar
                    </button>
                    <button type="submit" class="btn btn-success">
                        <i class="bi bi-check-circle"></i> Finalizar Visita
                    </button>
                </div>

            </form>

        </div>
    </div>
</div>


@section Scripts {
    <script src="~/js/Visita.js"></script>



}
