@model List<RegistroLlamadas.UI.Models.UsuarioDTO>

@{
    ViewData["Title"] = "Usuarios";
}

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3><i class="bi bi-people"></i> Gestión de Usuarios</h3>
        <button class="btn btn-primary" onclick="nuevoUsuario()">
            <i class="bi bi-plus-circle"></i> Nuevo Usuario
        </button>
    </div>

    <div class="table-responsive">
        <table id="tablaUsuarios" class="table table-striped table-bordered w-100">
            <thead>
                <tr>
                    <th>Usuario</th>
                    <th>Nombre</th>
                    <th>Correo</th>
                    <th>Estado</th>
                    <th>Rol</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var u in Model)
                {
                    <tr>
                        <td>@u.Usuario</td>
                        <td>@u.Nombre @u.PrimerApellido</td>
                        <td>@u.Correo</td>
                        <td><span class="badge bg-success">@u.EstadoNombre</span></td>
                        <td><span class="badge bg-primary">@u.RolNombre</span></td>
                        <td class="text-center">
                            <button class="btn btn-sm btn-warning"
                                    onclick="editarUsuario(@u.IdUsuario)">
                                <i class="bi bi-pencil-square"></i>
                            </button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

<!-- MODAL -->
<div class="modal fade" id="modalUsuario" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title" id="tituloModal">Usuario</h5>
                <button class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <input type="hidden" id="IdUsuario" />

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label>Usuario</label>
                        <input class="form-control" id="Usuario" />
                        <div class="invalid-feedback"></div>
                    </div>

                    <div class="col-md-6 mb-3">
                        <label>Correo</label>
                        <input class="form-control" id="Correo" />
                        <div class="invalid-feedback"></div>
                    </div>

                    <div class="col-md-6 mb-3">
                        <label>Nombre</label>
                        <input class="form-control" id="Nombre" />
                    </div>

                    <div class="col-md-6 mb-3">
                        <label>Primer Apellido</label>
                        <input class="form-control" id="PrimerApellido" />
                    </div>

                    <div class="col-md-6 mb-3">
                        <label>Segundo Apellido</label>
                        <input class="form-control" id="SegundoApellido" />
                    </div>

                    <div class="col-md-6 mb-3">
                        <label>Teléfono</label>
                        <input class="form-control" id="Telefono" />
                    </div>

                    <div class="col-md-6 mb-3">
                        <label>Estado</label>
                        <select class="form-select" id="EstadoId">
                            @foreach (var estado in ViewBag.Estados)
                            {
                                <option value="@estado.ID">@estado.Nombre</option>
                            }
                        </select>
                    </div>

                    <div class="col-md-6 mb-3">
                        <label>Rol</label>
                        <select class="form-select" id="RolId">
                            @foreach (var rol in ViewBag.Roles)
                            {
                                <option value="@rol.IdRol">@rol.Nombre</option>
                            }
                        </select>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button class="btn btn-success" onclick="guardarUsuario()">
                    <i class="bi bi-save"></i> Guardar
                </button>
            </div>

        </div>
    </div>
</div>

@section Scripts {
    <script>
        let modal;

        $(document).ready(function () {

            modal = new bootstrap.Modal(
                document.getElementById('modalUsuario'),
                { backdrop: 'static', keyboard: false }
            );

            $('#tablaUsuarios').DataTable({
                language: {
                    url: 'https://cdn.datatables.net/plug-ins/1.13.4/i18n/es-ES.json'
                }
            });

            $('input').on('input', function () {
                $(this).removeClass('is-invalid')
                       .next('.invalid-feedback').text('');
            });
        });

        function nuevoUsuario() {
            limpiarFormulario();
            $('#tituloModal').text('Nuevo Usuario');
            modal.show();
        }

        function editarUsuario(id) {
            $.get(`/Usuario/ObtenerUsuarioPorId?idUsuario=${id}`, function (resp) {
                if (resp.success) {
                    const u = resp.data;

                    $('#IdUsuario').val(u.idUsuario);
                    $('#Usuario').val(u.usuario);
                    $('#Correo').val(u.correo);
                    $('#Nombre').val(u.nombre);
                    $('#PrimerApellido').val(u.primerApellido);
                    $('#SegundoApellido').val(u.segundoApellido);
                    $('#Telefono').val(u.telefono);
                    $('#EstadoId').val(u.estadoId);
                    $('#RolId').val(u.rolId);

                    $('#tituloModal').text('Editar Usuario');
                    modal.show();
                }
            });
        }

        function guardarUsuario() {

            $('input').removeClass('is-invalid');
            $('.invalid-feedback').text('');

            const usuario = {
                IdUsuario: $('#IdUsuario').val() || 0,
                Usuario: $('#Usuario').val(),
                Correo: $('#Correo').val(),
                Nombre: $('#Nombre').val(),
                PrimerApellido: $('#PrimerApellido').val(),
                SegundoApellido: $('#SegundoApellido').val(),
                Telefono: $('#Telefono').val(),
                EstadoId: $('#EstadoId').val(),
                RolId: $('#RolId').val()
            };

            const url = usuario.IdUsuario > 0
                ? '/Usuario/ActualizarUsuario'
                : '/Usuario/RegistrarUsuario';

            $.ajax({
                url: url,
                method: 'POST',
                contentType: 'application/json',
                dataType: 'json',
                data: JSON.stringify(usuario),

                success: function () {
                    Swal.fire({
                        icon: 'success',
                        title: 'Usuario guardado',
                        confirmButtonColor: '#198754'
                    }).then(() => location.reload());
                },

                error: function (xhr) {

                    let mensaje = 'Ocurrió un error inesperado.';
                    let codigo = '';

                    if (xhr.responseJSON) {
                        mensaje = xhr.responseJSON.mensaje;
                        codigo = xhr.responseJSON.code;
                    }

                    $('#Usuario, #Correo')
                        .removeClass('is-invalid')
                        .next('.invalid-feedback').text('');

                    if (codigo === 'USUARIO_DUPLICADO') {
                        $('#Usuario')
                            .addClass('is-invalid')
                            .next('.invalid-feedback').text(mensaje);
                    }

                    if (codigo === 'CORREO_DUPLICADO') {
                        $('#Correo')
                            .addClass('is-invalid')
                            .next('.invalid-feedback').text(mensaje);
                    }

                    if (codigo === 'USUARIO_NO_EXISTE') {
                        Swal.fire({
                            icon: 'warning',
                            title: 'Usuario no válido',
                            text: 'El usuario ya no existe o fue eliminado.'
                        });
                        return;
                    }

                    if (codigo === 'SIN_CAMBIOS') {
                        Swal.fire({
                            icon: 'info',
                            title: 'Sin cambios',
                            text: 'No se realizaron cambios.'
                        });
                        return;
                    }

                    Swal.fire({
                        icon: 'error',
                        title: 'No se pudo guardar',
                        text: mensaje
                    });
                }
            });
        }

        function limpiarFormulario() {
            $('input').val('').removeClass('is-invalid');
            $('.invalid-feedback').text('');
            $('#EstadoId').val('1');
            $('#RolId').val('1');
            $('#IdUsuario').val('');
        }
    </script>
}
